<!-- Load muon if not already loaded -->
<link rel="import" href="../muon/muon.html"/>

<!-- Load script dependencies -->
<script src="./lib/zepto.min.js"></script>

<muon-element name="muon-svg">
  <template>
  </template>
  <script>
  (function() {
    var svgCache = {};
    
    var appendSVG = function(element, svgText) {
      element.innerHTML = svgText;
    }
    
    var loadSVG = function(element, src) {
      if(!svgCache[src]) {
        svgCache[src] = true;
        
        $.get(src, function(res) {
          svgCache[src] = res;
          appendSVG(element, res);
        });
      } else {
        // Elements will likely be created before the first load finishes,
        // so observe the cache for the completion of the first load.
        if(svgCache[src] == true) {
          var cacheObserver = function(changes) {
            changes.forEach(function(change) {
              if(change.name == src && typeof change.object[src] == "string") {
                Object.unobserve(svgCache, cacheObserver);
                appendSVG(element, svgCache[src]);
              }
            });
          }
          Object.observe(svgCache, cacheObserver);
        } else {
          appendSVG(element, svgCache[src]);
        }
      }
    }
    
    // Initialize the element.
    muon("muon-svg", {
      muonCreated: function() {
        this.src = this.getAttribute('src');
        
        if(this.src) {
          loadSVG(this, this.src);
        }
        
        // Tie attribute and src property changes together. (There's gotta be a better way to do this.)
        Object.observe(this, function(changes) {
          changes.forEach(function(change) {
            if(change.name == "src") {
              change.object.setAttribute("src", change.object.src);
            }
          });
        });
        
      },
      muonAttrChanged: function(attr, oldValue, newValue) {
        if(attr == "src") {
          this.src = newValue;
        }
        loadSVG(this, this.src);
      }
    });
  })();
  </script>
</muon-element>
